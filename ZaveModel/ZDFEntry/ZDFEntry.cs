///////////////////////////////////////////////////////////
//  ZDFEntry.cs
//  Implementation of the Interface IZDFEntry
//  Generated by Enterprise Architect
//  Created on:      28-Mar-2016 8:22:27 AM
//  Original author: Moshe
///////////////////////////////////////////////////////////

using System;
using System.Collections.Generic;
using System.Text;
using System.IO;
using System.ComponentModel;
using System.Linq;
using ZaveGlobalSettings.Data_Structures;
using Prism.Mvvm;
using ZaveGlobalSettings.Data_Structures.ZaveObservableCollection;
using ZaveModel.ZDFColors;
using Newtonsoft.Json;
using Newtonsoft.Json.Converters;
using Newtonsoft.Json.Linq;


namespace ZaveModel.ZDFEntry
{


    using CommentList = ObservableImmutableList<IEntryComment>;

    [JsonObject]
    [JsonConverter(typeof(ZDFEntryConverter))]
    public class ZDFEntry : BindableBase, IZDFEntry
    {





        [JsonIgnore]
        private int _id;
        [JsonProperty]
        public int ID { get { return _id; } }


        
        public ZDFEntry()
        {
            m_IEntryComment = new CommentList();
            //Source = new ZaveGlobalSettings.Data_Structures.SelectionState();
            _id = ZaveModel.ZDF.ZDFSingleton.setEntryID();
            HColor = new ColorCategory(new System.Drawing.Color(), "");
            //HColor = ColorCategory.FromWPFColor(System.Windows.Media.Color.FromRgb(255, 255, 0));
            _page = "";
            _name = "";
            _text = "";
            _dateModified = default(DateTime);
            _format = new SrcType();
        }

        public static ZDFEntry CreateZDFEntry(SelectionState src)
        {

            var entry = new ZDFEntry();
            if (src != null)
            {
                

                foreach (var item in src.Comments)
                {
                    entry.Comments.Add(new EntryComment(item.Text, item.Author));
                }

                entry._id = src.ID;
                entry._page = src.SelectionPage;
                entry._name = src.SelectionDocName;
                entry._text = src.SelectionText;
                entry._dateModified = src.SelectionDateModified;
                entry._format = src.srcType;
                entry._hColor = new ColorCategory(src.Color, src.Color.Name);

                
            }

            return entry;
        }

        ~ZDFEntry()
        {

        }

        public SelectionState toSelectionState()
        {
            var commentList = new List<SelectionComment>();
            foreach (var item in Comments)
            {
                var selCom = new SelectionComment();
                selCom.Author = item.Author.Name;
                selCom.ID = item.CommentID;
                selCom.Text = item.CommentText;
                commentList.Add(selCom);
            }
            return new SelectionState(this.ID, this.Name, this.Page, this.Text, this.DateModified, this.HColor.Color, this.Format, commentList);
        }


        #region Properties
        [JsonIgnore]
        private ColorCategory _hColor;
        [JsonProperty]
        public ColorCategory HColor
        {
            get { return _hColor; }
            set
            {
                SetProperty(ref _hColor, value);
            }

        }

        //private ZaveGlobalSettings.Data_Structures.SelectionState _source;
        //public ZaveGlobalSettings.Data_Structures.SelectionState Source
        //{
        //    get { return _source; }
        //    set
        //    {
        //        _source = value;
        //        //OnPropertyChanged("Source", Source);
        //    }
        //}
        [JsonIgnore]
        private string _page;
        [JsonProperty]
        public string Page
        {
            get { return _page; }
            set
            {
                SetProperty(ref _page, value);
            }
        }

        [JsonIgnore]
        private string _text;
        [JsonProperty]
        public string Text
        {
            get { return _text; }
            set
            {
                SetProperty(ref _text, value);
            }
        }
        [JsonIgnore]
        private DateTime _dateModified;
        [JsonProperty]
        public DateTime DateModified
        {
            get { return _dateModified; }
            set
            {
                SetProperty(ref _dateModified, value);
            }
        }
        [JsonIgnore]
        private SrcType _format;
        [JsonProperty]
        public SrcType Format
        {
            get { return _format; }
            set
            {
                SetProperty(ref _format, value);
            }
        }
        [JsonIgnore]
        private string _name;
        [JsonProperty]
        public string Name
        {
            get { return _name; }
            set
            {
                SetProperty(ref _name, value);
            }
        }

        [JsonIgnore]
        private CommentList m_IEntryComment;
        [JsonProperty]
        public CommentList Comments
        {
            get { return m_IEntryComment; }
            set { m_IEntryComment = value; }
        }

        #endregion


    }

    //end ZDFEntry

    class ZDFEntryConverter : JsonConverter
    {
        public override bool CanConvert(Type objectType)
        {
            return objectType == typeof(ZDFEntry);
        }

        public override bool CanWrite
        {
            get
            {
                return false;
            }
        }

        public override object ReadJson(JsonReader reader, Type objectType, object existingValue, JsonSerializer serializer)
        {
            #region Previous code 
            var jsonObject = JObject.Load(reader);
            var tempEntry = new SelectionState();
            tempEntry.ID = (int)jsonObject["ID"];
            tempEntry.SelectionDocName = (string)jsonObject["Name"];
            tempEntry.SelectionPage = (string)jsonObject["Page"];
            tempEntry.SelectionText = (string)jsonObject["Text"];
            tempEntry.SelectionDateModified = (DateTime)jsonObject["DateModified"];
            tempEntry.Color = new System.Drawing.Color();
            List<int> list = ((string)jsonObject["HColor"]["Color"]).Split(',').Select(int.Parse).ToList();
            tempEntry.Color = System.Drawing.Color.FromArgb(list[0], list[1], list[2]);
            tempEntry.srcType = (SrcType)int.Parse((string)jsonObject["Format"]);
            var comments = (JArray)jsonObject["Comments"]["_items"];
            foreach (var item in comments)
            {
                var selCom = new SelectionComment();
                selCom.Author = (string)item["Author"]["Name"];
                selCom.ID = (int)item["CommentID"];
                selCom.Text = (string)item["CommentText"];
                tempEntry.Comments.Add(selCom);
            }

            var entry = ZDFEntry.CreateZDFEntry(tempEntry);
            #endregion
            //var jsonObject = JObject.Load(reader);
            //var entry = new ZDFEntry
            //{
            //    //Comments = (List<EntryComment>) jsonObject.Se
            //};




            //switch (jsonObject["JobTitle"].Value())
            //{
            //    case "Software Developer":
            //        profession = new Programming();
            //        break;
            //    case "Copywriter":
            //        profession = new Writing();
            //        break;
            //}



            //serializer.Populate(jsonObject.CreateReader(), commentList);
            //return commentList;
            return entry;
        }

        public override void WriteJson(JsonWriter writer, object value, JsonSerializer serializer)
        {
            throw new NotImplementedException();
        }
    }


}//end namespace ZDFEntry